<div class="admin-wrap">
  <div class="admin-header">
    <h1>Admin · Productos</h1>
  </div>

  <!-- RESUMEN -->
  <section class="panel" style="margin-bottom: 12px;">
    <div
      style="display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap: wrap;"
    >
      <div>
        <div style="font-size: 14px; opacity: .8;">Productos activos</div>
        <div style="font-size: 22px; font-weight: 700;">
          {{ productsCount() }}
        </div>
      </div>

      <div>
        <div style="font-size: 14px; opacity: .8;">Stock total disponible</div>
        <div style="font-size: 22px; font-weight: 700;">
          {{ totalStock() }}
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <button (click)="toggleProducts()" class="verProductos">
          {{ showProducts() ? 'Ocultar productos' : 'Ver productos' }}
        </button>

        <button class="primary" (click)="toggleForm()">
          {{ showForm() ? 'Cerrar' : 'Agregar producto' }}
        </button>
      </div>
    </div>
  </section>

  <!-- TABLA DE PRODUCTOS -->
  <section *ngIf="showProducts()" class="panel" style="margin-bottom: 12px;">
    <h3 style="margin: 0 0 10px 0;">Productos</h3>

    <!-- ✅ BUSCADOR + FILTRO CATEGORIA + PAGE SIZE -->
    <div
      style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 8px 0 12px;"
    >
      <input
        style="min-width:260px;"
        placeholder="Buscar por nombre, descripción, keywords..."
        [ngModel]="q()"
        (ngModelChange)="onSearchChange($event)"
      />

      <select
        [ngModel]="categoriaFilter()"
        (ngModelChange)="onCategoriaChange($event)"
      >
        <option value="ALL">Todas las categorías</option>
        <option value="LIBRERIA">Librería</option>
        <option value="COMBOS">Combos</option>
        <option value="JUGUETERIA">Juguetería</option>
        <option value="BAZAR">Bazar</option>
      </select>
    </div>

    <div style="overflow:auto;">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Keywords</th>
            <th>Stock</th>
            <th>Precio</th>
            <th style="width: 220px;">Acciones</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let p of pagedProducts()">
            <!-- ✅ IMÁGENES (ver / editar) -->
            <td>
              <ng-container *ngIf="isEditing(p.id); else vImg">
                <div
                  style="display:flex; flex-direction:column; gap:8px; min-width: 220px;"
                >
                  <div style="display:flex; flex-direction:column; gap:6px;">
                    <label style="font-size:12px; opacity:.8;">Imagen 1</label>
                    <input
                      type="file"
                      accept="image/*"
                      (change)="onEditFileSelected($event, 1)"
                    />
                  </div>

                  <div style="display:flex; flex-direction:column; gap:6px;">
                    <label style="font-size:12px; opacity:.8;">Imagen 2</label>
                    <input
                      type="file"
                      accept="image/*"
                      (change)="onEditFileSelected($event, 2)"
                    />
                  </div>

                  <div style="display:flex; flex-direction:column; gap:6px;">
                    <label style="font-size:12px; opacity:.8;">Imagen 3</label>
                    <input
                      type="file"
                      accept="image/*"
                      (change)="onEditFileSelected($event, 3)"
                    />
                  </div>

                  <div *ngIf="uploadingImg()" style="font-size: 12px; opacity: .8;">
                    Subiendo imagen...
                  </div>

                  <!-- ✅ previews de lo que quedó en editRow (aún no guardado) -->
                  <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
                    <img
                      *ngIf="editRow().imgUrl"
                      class="thumb img-grid"
                      [src]="fileUrl(editRow().imgUrl)"
                      [alt]="p.nombre"
                    />
                    <img
                      *ngIf="editRow().imgUrl2"
                      class="thumb img-grid"
                      [src]="fileUrl(editRow().imgUrl2)"
                      [alt]="p.nombre"
                    />
                    <img
                      *ngIf="editRow().imgUrl3"
                      class="thumb img-grid"
                      [src]="fileUrl(editRow().imgUrl3)"
                      [alt]="p.nombre"
                    />
                  </div>

                  <div style="font-size:11px; opacity:.7;">
                    * Subís y luego <b>Guardás</b> para confirmar.
                  </div>
                </div>
              </ng-container>

              <ng-template #vImg>
                <div style="display:flex; gap:6px; flex-wrap:wrap; min-width: 180px;">
                  <!-- principal (fallback a p.img si no hay imgUrl) -->
                  <img
                    class="thumb img-grid"
                    [src]="fileUrl(p.imgUrl || p.img)"
                    [alt]="p.nombre"
                  />

                  <img
                    *ngIf="p.imgUrl2"
                    class="thumb img-grid"
                    [src]="fileUrl(p.imgUrl2)"
                    [alt]="p.nombre"
                  />

                  <img
                    *ngIf="p.imgUrl3"
                    class="thumb img-grid"
                    [src]="fileUrl(p.imgUrl3)"
                    [alt]="p.nombre"
                  />
                </div>
              </ng-template>
            </td>

            <td>
              <ng-container *ngIf="isEditing(p.id); else vNombre">
                <input
                  [ngModel]="editRow().nombre"
                  (ngModelChange)="setEditField('nombre', $event)"
                />
              </ng-container>
              <ng-template #vNombre>{{ p.nombre }}</ng-template>
            </td>

            <td>
              <ng-container *ngIf="isEditing(p.id); else vDesc">
                <input
                  [ngModel]="editRow().descripcionCorta"
                  (ngModelChange)="setEditField('descripcionCorta', $event)"
                />
              </ng-container>
              <ng-template #vDesc>{{ p.descripcionCorta }}</ng-template>
            </td>

            <td>
              <ng-container *ngIf="isEditing(p.id); else vKw">
                <input
                  placeholder="kw1, kw2, kw3"
                  [ngModel]="editRow().keywords"
                  (ngModelChange)="setEditField('keywords', $event)"
                />
              </ng-container>
              <ng-template #vKw>{{ (p.keywords ?? []).join(', ') || '-' }}</ng-template>
            </td>

            <td>
              <ng-container *ngIf="isEditing(p.id); else vStock">
                <input
                  type="number"
                  min="0"
                  style="width: 90px;"
                  [ngModel]="editRow().stock"
                  (ngModelChange)="setEditField('stock', +$event)"
                />
              </ng-container>
              <ng-template #vStock>{{ p.stock ?? 0 }}</ng-template>
            </td>

            <td>
              <ng-container *ngIf="isEditing(p.id); else vPrecio">
                <input
                  type="number"
                  min="0"
                  step="0.01"
                  style="width: 110px;"
                  [ngModel]="editRow().precio"
                  (ngModelChange)="setEditField('precio', +$event)"
                />
              </ng-container>
              <ng-template #vPrecio>{{ (p.precio ?? 0) | number:'1.2-2' }}</ng-template>
            </td>

            <td>
              <ng-container *ngIf="isEditing(p.id); else vBtns">
                <button (click)="cancelEdit()">Cancelar</button>
                <button
                  class="primary"
                  (click)="saveEdit(p.id)"
                  [disabled]="savingRow()"
                >
                  {{ savingRow() ? 'Guardando...' : 'Guardar' }}
                </button>
              </ng-container>

              <ng-template #vBtns>
                <button (click)="startEdit(p)">Modificar</button>
                <button class="danger" (click)="remove(p.id)">Eliminar</button>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- ✅ PAGINADOR -->
      <div
        style="display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top: 12px;"
      >
        <select
          [ngModel]="pageSize()"
          (ngModelChange)="pageSize.set(+$event); page.set(1)"
        >
          <option [ngValue]="5">5 por página</option>
          <option [ngValue]="10">10 por página</option>
          <option [ngValue]="20">20 por página</option>
          <option [ngValue]="50">50 por página</option>
        </select>

        <div style="font-size:12px; opacity:.8;">
          Mostrando {{ pagedProducts().length }} de {{ totalFiltered() }}
        </div>

        <button (click)="goPrev()" [disabled]="page() <= 1">Anterior</button>

        <div style="font-size: 13px;">
          Página {{ page() }} / {{ totalPages() }}
        </div>

        <button (click)="goNext()" [disabled]="page() >= totalPages()">Siguiente</button>
      </div>
    </div>
  </section>

  <div class="tabs">
    <button (click)="tab.set('single')" [class.active]="tab() === 'single'">
      Producto nuevo
    </button>
    <!-- <button (click)="tab.set('bulk')" [class.active]="tab() === 'bulk'">
      Carga masiva
    </button>-->
  </div>

  <!-- SINGLE -->
  <section *ngIf="tab() === 'single'" class="panel">
    <div *ngIf="showForm(); else noForm">
      <div class="grid">
        <label>
          <span>Nombre *</span>
          <input
            [ngModel]="form().nombre"
            (ngModelChange)="setField('nombre', $event)"
          />
        </label>

        <!-- ✅ 3 imágenes -->
        <label>
          <span>Imágenes (hasta 3)</span>

          <div style="display:flex; flex-direction:column; gap:8px;">
            <input type="file" accept="image/*" (change)="onFileSelected($event, 1)" />
            <input type="file" accept="image/*" (change)="onFileSelected($event, 2)" />
            <input type="file" accept="image/*" (change)="onFileSelected($event, 3)" />
          </div>

          <div
            *ngIf="uploadingImg()"
            style="font-size: 12px; opacity: .8; margin-top: 6px;"
          >
            Subiendo imagen...
          </div>

          <!-- ✅ previews -->
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px;">
            <ng-container *ngIf="form().imgUrl">
              <img
                [src]="fileUrl(form().imgUrl)"
                alt="preview 1"
                style="max-width: 120px; border-radius: 8px; border: 1px solid #ddd;"
              />
            </ng-container>

            <ng-container *ngIf="form().imgUrl2">
              <img
                [src]="fileUrl(form().imgUrl2)"
                alt="preview 2"
                style="max-width: 120px; border-radius: 8px; border: 1px solid #ddd;"
              />
            </ng-container>

            <ng-container *ngIf="form().imgUrl3">
              <img
                [src]="fileUrl(form().imgUrl3)"
                alt="preview 3"
                style="max-width: 120px; border-radius: 8px; border: 1px solid #ddd;"
              />
            </ng-container>
          </div>

          <!-- ✅ paths guardados -->
          <div *ngIf="form().imgUrl" style="margin-top: 8px;">
            <div style="font-size: 12px; opacity: .8;">Guardadas como:</div>
            <div style="font-size: 12px; word-break: break-all;">
              1) {{ form().imgUrl }}
            </div>
            <div *ngIf="form().imgUrl2" style="font-size: 12px; word-break: break-all;">
              2) {{ form().imgUrl2 }}
            </div>
            <div *ngIf="form().imgUrl3" style="font-size: 12px; word-break: break-all;">
              3) {{ form().imgUrl3 }}
            </div>
          </div>
        </label>

        <label class="full">
          <span>Descripción corta</span>
          <input
            [ngModel]="form().descripcionCorta"
            (ngModelChange)="setField('descripcionCorta', $event)"
          />
        </label>

        <label class="full">
          <span>Info Modal (larga)</span>
          <textarea
            rows="4"
            [ngModel]="form().infoModal"
            (ngModelChange)="setField('infoModal', $event)"
          ></textarea>
        </label>

        <!-- ✅ CATEGORÍA: desplegable -->
        <label class="full">
          <span>Categoría</span>
          <select
            [ngModel]="form().categorias"
            (ngModelChange)="setField('categorias', $event)"
          >
            <option value="" disabled>Seleccioná una categoría</option>
            <option value="Libreria">Libreria</option>
            <option value="combos">combos</option>
            <option value="jugueteria">jugueteria</option>
            <option value="bazar">bazar</option>
          </select>
          <div style="font-size: 12px; opacity: .7; margin-top: 6px;">
            Se guarda en <b>categorias</b> como texto (MVP).
          </div>
        </label>

        <!-- ✅ KEYWORDS: multiselect hasta 4 -->
        <label class="full">
          <span>Palabras clave (hasta 4)</span>

          <div class="kw-box selects-box">
            <div class="kw-item" *ngFor="let k of keywordsOpts">
              <label style="display:flex; gap:8px; align-items:center;">
                <input
                  type="checkbox"
                  [checked]="selectedKeywords().includes(k)"
                  (change)="toggleKeyword(k, $any($event.target).checked)"
                />
                <span>{{ k }}</span>
              </label>
            </div>

            <div style="font-size: 12px; opacity:.75; margin-top:8px;">
              Seleccionadas: {{ selectedKeywords().join(', ') || '-' }}
            </div>
          </div>
        </label>

        <!-- ✅ PRECIO con símbolo $ -->
        <label>
          <span>Precio</span>

          <div style="display:flex; align-items:center; gap:8px;">
            <span style="font-weight:700;">$</span>
            <input
              type="number"
              min="0"
              step="0.01"
              style="width: 140px;"
              [ngModel]="form().precio"
              (ngModelChange)="setField('precio', +$event)"
            />
          </div>
        </label>

        <label>
          <span>Stock</span>
          <input
            type="number"
            min="0"
            [ngModel]="form().stock"
            (ngModelChange)="setField('stock', +$event)"
          />
        </label>
      </div>

      <div class="actions">
        <button
          class="primary"
          (click)="saveSingle()"
          [disabled]="loading() || uploadingImg()"
        >
          {{ loading() ? 'Guardando...' : 'Crear producto' }}
        </button>
      </div>
    </div>

    <ng-template #noForm>
      <p class="hint" style="margin: 0;">
        Tocá <b>“Agregar producto”</b> para cargar uno nuevo.
      </p>
    </ng-template>
  </section>

  <!-- BULK -->
  <section *ngIf="tab() === 'bulk'" class="panel">
    <p class="hint">
      Pegá un JSON array con productos (DTO real: nombre, descripcionCorta, imgUrl, keywords, stock, etc).
    </p>

    <textarea
      rows="14"
      [ngModel]="bulkText()"
      (ngModelChange)="bulkText.set($event)"
    ></textarea>

    <div class="actions">
      <button class="primary" (click)="saveBulk()" [disabled]="loading()">
        {{ loading() ? 'Cargando...' : 'Cargar en masa' }}
      </button>
    </div>
  </section>
</div>
